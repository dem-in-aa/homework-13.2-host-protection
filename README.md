# Домашнее задание к занятию  «Защита хоста» Андрей Дёмин

### Задание 1

1. Установите **eCryptfs**.
2. Добавьте пользователя cryptouser.
3. Зашифруйте домашний каталог пользователя с помощью eCryptfs.


*В качестве ответа  пришлите снимки экрана домашнего каталога пользователя с исходными и зашифрованными данными.*  

<ins>Ответ</ins>:

Для выполнения задачи скачан и импортирован **UbuntuServer_22.04_VB_LinuxVMImages.COM.vdi**

Создан профиль пользователя:

```
sudo su - 
```
```
adduser --encrypt-home cryptouser
```
![](img/1-1.png)

По мере выполнения задачи профиль пользователя был удален, поэтому при создании его вновь был добавлен флаг --force

```
adduser --encrypt-home --force cryptouser
```
![](img/1-2.png)

Для возможности выполнения операций с файлами в каталоге от имени пользователя **cryptouser** ему предоставлены права:

```
chmod 755 /home/cryptouser
```
![](img/1-3.png)

После создания файлов содержимое каталога выглядит следующим образом:

![](img/1-4.png)
---
![](img/1-5.png)

Содержимое файлов доступно для чтения:

![](img/1-7.png)

Шифрование каталога **cryptouser** происходит путем его монтирования с файловой системой ecryptfs:

```
mount -t ecryptfs /home/cryptouser/ /home/cryptouser/
```
![](img/1-6.png)

После размонтирования каталога можно увидеть содержащиеся в нем файлы, однако их содержимое зашифровано:

![](img/1-8.png)


### Задание 2

1. Установите поддержку **LUKS**.
2. Создайте небольшой раздел, например, 100 Мб.
3. Зашифруйте созданный раздел с помощью LUKS.

*В качестве ответа пришлите снимки экрана с поэтапным выполнением задания.*

<ins>Ответ</ins>:

Для ВМ добавлен виртуальный hdd емкостью 150 Мб, установлена утилита **gparted**
```
sudo apt install gparted
```
Установлена **LUKS** :
```
sudo apt-get install cryptsetup
```
Проверка версии:
```
cryptsetup --version
```
![](img/2-2.png)

В ходе форматирования создан mbr-раздел и выполнено монтирование файловой системы:

![](img/2-3.png)

Создан шифрованный раздел:

```
sudo cryptsetup -y -v --type luks2 luksFormat /dev/sdb1
```
![](img/2-4.png)

Произведено монтирование и форматирование шифрованного раздела:

```
sudo cryptsetup luksOpen /dev/sdb1 disk
```
```
sudo dd if=/dev/zero of=/dev/mapper/disk
sudo mkfs.ext4 /dev/mapper/disk
```
![](img/2-5.png)

Создан и смонтирован каталог **.secret**

```
mkdir .secret
sudo mount /dev/mapper/disk .secret/ 
```
![](img/2-6.png)

Содержимое каталога **.secret**

![](img/2-7.png)

Созданы файлы:

![](img/2-8.png)
---
![](img/2-9.png)

После размонтирования файлы в каталоге **.secret** скрыты:

```
sudo umount .secret
sudo cryptsetup luksClose disk
```
![](img/2-10.png)


### Задание 3 *

1. Установите **apparmor**.
2. Повторите эксперимент, указанный в лекции.
3. Отключите (удалите) apparmor.


*В качестве ответа пришлите снимки экрана с поэтапным выполнением задания.*

<ins>Ответ</ins>:

После установки **apparmor** проверен статус загруженных профилей:

![](img/3-1.png)

В каталоге /etc/apparmor.d расположены профили **AppArmor**. Его можно использовать для управления режимом всех профилей.

![](img/3-2.png)

Чтобы перевести все профили в режим обучения:
```
sudo aa-complain /etc/apparmor.d/*
```
Чтобы перевести все профили в защищенный режим:
```
sudo aa-enforce /etc/apparmor.d/*
```
Для запуска утилиты **ping** по команде **man** произведены следующие действия:
```
sudo cp /usr/bin/man /usr/bin/man1
sudo cp /bin/ping /usr/bin/man
sudo aa-complain /usr/bin/man
sudo man 127.0.0.1
```
![](img/3-3.png)

После этого **apparmor** переведен в защищенный режим:
```
sudo aa-enforce man
```

![](img/3-4.png)

Остановка сервиса **apparmor**
```
sudo service apparmor stop
```
![](img/3-5.png)

Выгрузка профилей:
```
sudo service apparmor teardown
```
![](img/3-6.png)

Удаление **apparmor**

![](img/3-7.png)

